<div class="w-full bg-white border border-gray-200 rounded-md shadow-sm">
  @if (!groupedApplications || groupedApplications.length === 0) {
    <div class="flex items-center justify-center py-12 px-4">
      <p class="text-gray-500 text-center">No IPO applications to display</p>
    </div>
  } @else {
    <!-- Table View -->
    <div>
      <table class="w-full border-collapse">
        <thead class="sticky top-0 z-20 bg-gray-100 shadow-sm">
        <tr class="text-left text-sm font-semibold text-gray-700 uppercase tracking-wider bg-gray-100 border-b border-gray-300">
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('symbol')">
              SYMBOL
              <span class="text-[10px]" *ngIf="getSortIndicator('symbol')">{{ getSortIndicator('symbol') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('investorType')">
              INVESTOR
              <span class="text-[10px]" *ngIf="getSortIndicator('investorType')">{{ getSortIndicator('investorType') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('category')">
               TYPE
              <span class="text-[10px]" *ngIf="getSortIndicator('category')">{{ getSortIndicator('category') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('created_at')">
              APPLIED ON
              <span class="text-[10px]" *ngIf="getSortIndicator('created_at')">{{ getSortIndicator('created_at') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('updated_at')">
              LAST UPDATE ON
              <span class="text-[10px]" *ngIf="getSortIndicator('updated_at')">{{ getSortIndicator('updated_at') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('upi_id')">
              UPI ID
              <span class="text-[10px]" *ngIf="getSortIndicator('upi_id')">{{ getSortIndicator('upi_id') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('status')">
              STATUS
              <span class="text-[10px]" *ngIf="getSortIndicator('status')">{{ getSortIndicator('status') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-center">ACTIONS</th>
        </tr>
        </thead>
        <tbody class="bg-white">
        <ng-container *ngFor="let group of sortedGroupedApplications; let isLast = last; trackBy: trackByUserId">

          <!-- User Header Row -->
          <tr class="border-b border-gray-200 text-gray-700 text-sm md:text-sm">
            <td colspan="8" class="px-2 md:px-4 whitespace-nowrap">
              <app-user-info-header
                [userId]="group.userId"
                [userName]="group.userName || group.userId"
                [fullName]="group.fullName || group.userName"
                [avatarUrl]="group.avatarUrl"
                [fallbackAvatarUrl]="fallbackAvatarUrl">
              </app-user-info-header>
            </td>
          </tr>

          <!-- Application Rows -->
          <ng-container *ngFor="let application of group.applications; trackBy: trackByApplicationId">
            <tr class="border-b border-gray-200 text-sm text-gray-700 hover:bg-blue-50 transition-colors duration-150">

              <!-- Symbol -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
                <span class="text-gray-700 font-semibold">{{ application.symbol }}</span>
              </td>

              <!-- Investor Type -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
                <app-small-chip
                  [text]="getInvestorType(application.investor_type)"
                  [color]="'gray'">
                </app-small-chip>
              </td>
              <!-- ipo Type -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
                <app-small-chip
                  [text]="getIpoType(application.category)"
                  [color]="'purple'">
                </app-small-chip>
              </td>

              <!-- Applied On -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap  text-sm">
                {{ application.created_at | istDate:'date-ordinal' }}
              </td>

              <!-- Last Update On -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap  text-sm">
                {{ application.updated_at | istDate:'datetime-ordinal-no-mod' }}
              </td>

              <!-- UPI ID -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap text-sm">
                {{ application.upi_id }}
              </td>

              <!-- Status -->
              <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
                <app-small-chip class="cursor-pointer"
                  [matTooltip]="application.payment_status"
                  [text]="application.status"
                  [color]="getStatusChipColor(application.status)">
                </app-small-chip>
              </td>

              <!-- Actions -->
              <td class="px-2 md:px-4 py-2 md:py-3 text-center whitespace-nowrap">
                <div class="flex items-center justify-center gap-2">
                  <button
                    (click)="toggleBidDetails(application.id)"
                    class="text-blue-600 hover:underline">
                    {{ isBidDetailsExpanded(application.id) ? 'Hide Bids' : 'See Bids' }}
                  </button>
                  <button
                    *ngIf="application.status?.toUpperCase() !== 'CANCELLED' && application.status?.toUpperCase() !== 'ALLOTTED' && application.status?.toUpperCase() !== 'NOT ALLOTTED'"
                    (click)="cancelApplication(application)"
                    [disabled]="cancellationInProgress.has(application.id)"
                    class="text-red-600 hover:underline cursor-pointer disabled:text-gray-400 disabled:cursor-not-allowed">
                    {{ cancellationInProgress.has(application.id) ? 'Cancelling...' : 'Cancel' }}
                  </button>
                </div>
              </td>
            </tr>

            <!-- Bids Details Row (Collapsible) -->
            <tr *ngIf="isBidDetailsExpanded(application.id)">
              <td colspan="8" class="px-2 md:px-4 py-2 border-t border-gray-200">
                <div class="relative w-full">
                  <!-- Timeline Header -->
                  <h4 class="text-sm font-semibold text-gray-700 mb-4">Bid Details</h4>

                  <!-- Bids List -->
                  <div *ngIf="application.bids && application.bids.length > 0; else noBids" class="space-y-3">
                    <div *ngFor="let bid of application.bids" class="rounded-md border border-gray-200 p-3 bg-white text-sm">
                      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-gray-700">
                        <div class="flex items-center gap-1">
                          <span class="text-gray-400 ">Status:</span>
                          <span class="">{{ bid.status | uppercase }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-400 ">Quantity:</span>
                          <span class="">{{ bid.quantity }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-400 ">Price:</span>
                          <span class="">{{ bid.price }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-400 ">Amount:</span>
                          <span class="">â‚¹{{ bid.amount }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-400 ">Exchange ID:</span>
                          <span class=" ">{{ bid.exchange_id }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-400 ">Auto Cutoff:</span>
                          <span class="">{{ bid.auto_cutoff ? 'Yes' : 'No' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- No Bids Message -->
                  <ng-template #noBids>
                    <p class="text-gray-400 text-sm">No bids available</p>
                  </ng-template>
                </div>
              </td>
            </tr>
          </ng-container>

          <!-- User Separator -->
          <tr *ngIf="!isLast">
            <td colspan="8" class="py-1">
              <div class="border-b border-dashed border-gray-100"></div>
            </td>
          </tr>
        </ng-container>
        </tbody>
      </table>
    </div>
  }
</div>

