<div class="page-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex items-center justify-center py-12">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="text-gray-600 mt-4">Loading market holidays</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="flex items-center justify-center py-12 px-4">
    <p class="text-red-500 text-center">{{ errorMessage }}</p>
  </div>

  <!-- Table -->
  <div *ngIf="!isLoading && !errorMessage" class="page-content">
    @if (!holidays || holidays.length === 0) {
      <div class="flex items-center justify-center py-12 px-4">
        <p class="text-gray-500 text-center">No holidays to display</p>
      </div>
    } @else {
      <table class="w-full border-collapse">
        <thead class="sticky top-0 z-20 bg-gray-100 shadow-sm">
        <tr class="text-left text-sm font-semibold text-gray-700 uppercase tracking-wider bg-gray-100 border-b border-gray-300">
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('date')">
              DATE
              <span class="text-[10px]" *ngIf="getSortIndicator('date')">{{ getSortIndicator('date') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('description')">
              DESCRIPTION
              <span class="text-[10px]" *ngIf="getSortIndicator('description')">{{ getSortIndicator('description') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-left whitespace-nowrap">
            <button type="button" class="flex items-center gap-1 w-full text-left" (click)="setSort('holiday_type')">
              TYPE
              <span class="text-[10px]" *ngIf="getSortIndicator('holiday_type')">{{ getSortIndicator('holiday_type') }}</span>
            </button>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-right whitespace-nowrap">
            <span>CLOSED EXCHANGES</span>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-right whitespace-nowrap">
            <span>OPEN EXCHANGES</span>
          </th>
          <th scope="col" class="px-2 md:px-4 py-2 md:py-3 text-center">ACTIONS</th>
        </tr>
        </thead>
        <tbody class="bg-white">
        <ng-container *ngFor="let holiday of sortedHolidays; trackBy: trackById">
          <!-- Holiday Row -->
          <tr
            [class.opacity-50]="isPastHoliday(holiday.date)"
            class="border-b border-gray-200 text-sm  transition-colors duration-150"
            [class]="isPastHoliday(holiday.date) ? 'hover:bg-gray-50' : 'hover:bg-blue-50'">

            <!-- Date -->
            <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
              <span class="font-medium">{{ holiday.date | istDate:'date-ordinal-with-day' }}</span>
            </td>

            <!-- Description -->
            <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
              <span class="text-sm">{{ holiday.description }}</span>
            </td>

            <!-- Type -->
            <td class="px-2 md:px-4 py-2 md:py-3 whitespace-nowrap">
              <app-small-chip
                [text]="holiday.holiday_type"
                [color]="holiday.holiday_type === 'TRADING_HOLIDAY' ? 'red' : 'orange'">
              </app-small-chip>
            </td>

            <!-- Closed Count -->
            <td class="px-2 md:px-4 py-2 md:py-3 text-right whitespace-nowrap">
              <span class="font-semibold text-gray-700">{{ (holiday.closed_exchanges && holiday.closed_exchanges.length) || 0 }}</span>
            </td>

            <!-- Open Count -->
            <td class="px-2 md:px-4 py-2 md:py-3 text-right whitespace-nowrap">
              <span class="font-semibold text-gray-700">{{ (holiday.open_exchanges && holiday.open_exchanges.length) || 0 }}</span>
            </td>

            <!-- Actions -->
            <td class="px-2 md:px-4 py-2 md:py-3 text-center whitespace-nowrap">
              <button
                (click)="toggleExchanges(holiday)"
                class="text-blue-600 hover:underline">
                {{ isExchangesExpanded(holiday) ? 'Hide' : 'See Exchanges' }}
              </button>
            </td>
          </tr>

          <!-- Exchanges Detail Row (Collapsible) -->
          <tr *ngIf="isExchangesExpanded(holiday)">
            <td colspan="6" class="px-2 md:px-4 py-2 border-t border-b border-gray-200">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Closed Exchanges -->
                <div>
                  <label class="text-base font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <fa-icon [icon]="faTimesCircle" class="text-red-600"></fa-icon>
                    Closed Exchanges
                  </label>
                  <div class="flex flex-wrap gap-2">
                    <div *ngFor="let exchange of (holiday.closed_exchanges || [])"
                         class="bg-red-50 border border-red-200 rounded px-3 py-1 text-sm font-medium text-red-800 inline-block">
                      {{ exchange }}
                    </div>
                    <div *ngIf="!holiday.closed_exchanges || holiday.closed_exchanges.length === 0" class="text-gray-500 text-sm italic">
                      No closed exchanges
                    </div>
                  </div>
                </div>

                <!-- Open Exchanges with Timings -->
                <div>
                  <label class="text-base font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <fa-icon [icon]="faCheckCircle" class="text-green-600"></fa-icon>
                    Open Exchanges
                  </label>
                  <div class="flex flex-wrap gap-2">
                    <div *ngFor="let timing of (holiday.open_exchanges || [])"
                         [matTooltip]="getExchangeTimingTooltip(timing.start_time, timing.end_time)"
                         matTooltipPosition="above"
                         class="bg-green-50 border border-green-200 rounded px-3 py-1 text-sm font-medium text-green-800 inline-block cursor-pointer">
                      {{ timing.exchange }}
                    </div>
                    <div *ngIf="!holiday.open_exchanges || holiday.open_exchanges.length === 0" class="text-gray-500 text-sm italic">
                      All exchanges closed
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
        </tbody>
      </table>
    }
  </div>
</div>

