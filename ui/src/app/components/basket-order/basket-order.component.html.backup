<div class="page-container">

    <!-- Main Container -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 text-gray-700">
      <!-- Search Section -->
      <div class="p-4 border-b border-gray-200">
        <!-- Trading Account Selector and Search Input -->
        <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
          <!-- Trading Account Selector -->
          <div class="flex-none w-full sm:w-[40%]">
            <app-user-dropdown
              [(selectedUserId)]="selectedTradingAccountId"
              (selectUser)="calculateBasketMargin(); fetchFundsData()"
              [placeholder]="'Select Trading Account'">
            </app-user-dropdown>
          </div>
          <!-- Search Input and Dropdown Container -->
          <div class="relative flex-1 w-full">
            <fa-icon [icon]="faSearch" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></fa-icon>
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="onSearchTermChange($event)"
              class="pl-10 pr-3 py-2 w-full border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-100 focus:outline-none"
              placeholder="Search and add instruments eg: infy, nifty fut, etc"
            />

            <!-- Search Dropdown - Adjusted positioning -->
            <div *ngIf="fetchedInstruments.length > 0 && searchTerm.length > 0"
                 class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto z-10">
              <div *ngFor="let instrument of fetchedInstruments"
                   class="px-3 py-2 hover:bg-blue-50 cursor-pointer transition-colors"
                   (click)="addToBasket(instrument)"
                   (keydown.enter)="addToBasket(instrument)"
                   tabindex="0"
                   role="button">
                <div class="flex justify-between items-center">
                  <div class="text-gray-700 text-sm">{{ instrument.displayName }}</div>
                  <div class="text-sm text-gray-500 uppercase">{{ instrument.segment }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Type: Intraday / Overnight -->
        <div class="flex items-center gap-6 mt-3">
          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input
              type="radio"
              name="productType"
              [(ngModel)]="isIntraday"
              [value]="true"
              (change)="onIntradayChange()"
              class="form-radio text-orange-500 h-4 w-4"
            />
            <span class="text-sm text-gray-700">Intraday</span>
          </label>

          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input
              type="radio"
              name="productType"
              [(ngModel)]="isIntraday"
              [value]="false"
              (change)="onIntradayChange()"
              class="form-radio text-purple-500 h-4 w-4"
            />
            <span class="text-sm text-gray-700">Overnight</span>
          </label>
        </div>

      </div>

      <!-- Basket Items -->
      <div class="min-h-[30vh]">
        <div *ngIf="isLoading" class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        </div>
        <div *ngIf="!isLoading && basketItems.length === 0" class="text-center py-16 px-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Your basket is empty</h3>
          <p class="text-gray-500 text-sm md:text-base">Search and select instruments above to add them to your basket</p>
        </div>

        <!-- Desktop Table View (Hidden on Mobile) -->
        <div *ngIf="!isLoading && basketItems.length > 0" class="hidden md:block overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100 text-gray-600">
              <tr>
                <th class="px-4 py-2 text-left h-10">Instrument</th>
                <th class="px-4 py-2 text-left h-10">Transaction</th>
                <th class="px-4 py-2 text-left h-10">Order Type</th>
                <th class="px-4 py-2 text-left h-10">Qty</th>
                <th class="px-4 py-2 text-left h-10">Price</th>
                <th class="px-4 py-2 text-left h-10">Margin</th>
                <th class="px-4 py-2 text-left h-10">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <tr *ngFor="let item of basketItems; trackBy: trackById; let i = index"
                  class="hover:bg-gray-50 transition-colors">
                <!-- Instrument Name & Exchange on first line, LTP on second line -->
                <td class="px-4 py-3">
                  <div class="flex flex-col">
                    <div class="flex items-center gap-2">
                      <span class="text-gray-700 text-sm">{{ item.displayName }}</span>
                      <span class="text-sm text-gray-400 uppercase">{{ item.exchange }}</span>
                      <app-market-depth-invoker [title]="item.displayName"
                                              [instrumentToken]="item.instrumentToken"
                                              [iconColor]="'gray'">
                      </app-market-depth-invoker>
                      <span class="text-sm" [ngClass]="color(item.change)">
                        {{ item.lastPrice | number: '1.2-2' }}
                      </span>
                      <span class="text-sm px-1.5 py-0.5 rounded-md "
                            [ngClass]="{
                              'bg-green-50 text-green-600': item.change > 0,
                              'bg-red-50 text-red-600': item.change < 0,
                              'bg-gray-50 text-gray-600': item.change === 0
                            }">
                        {{ item.change / 100 | percent: '1.2-2' }}
                      </span>
                      <app-small-chip [text]="item.productType" [color]="item.productType === 'MIS' ? 'orange':'purple'"></app-small-chip>
                    </div>

                  </div>
                </td>

                <!-- Transaction Type (Buy/Sell) - Clickable -->
                <td class="px-4 py-3  cursor-pointer">
                  <app-small-chip
                    (click)="toggleTransactionType(item)"
                    (keydown.enter)="toggleTransactionType(item)"
                    [text]="item.transactionType"
                    [color]="item.transactionType === 'BUY' ? 'blue' : 'red'"
                    tabindex="0"
                    role="button">
                  </app-small-chip>
                </td>

                <!-- Order Type - Clickable -->
                <td class="px-4 py-3  cursor-pointer">
                  <app-small-chip
                    (click)="toggleOrderType(item)"
                    (keydown.enter)="toggleOrderType(item)"
                    [text]="item.orderType"
                    [color]="'gray'"
                    tabindex="0"
                    role="button">
                  </app-small-chip>
                </td>

                <!-- Quantity - Editable -->
                <td class="px-4 py-3 ">
                  <input
                    type="number"
                    [(ngModel)]="item.quantity"
                    (input)="updateQuantity(item, $event)"
                    min="1"
                    class="w-20 px-2 py-1 border border-gray-300 rounded-md  focus:ring-2 focus:ring-blue-100 focus:outline-none"
                  />
                </td>

                <!-- Price - Editable -->
                <td class="px-4 py-3 ">
                  <input
                    type="number"
                    [(ngModel)]="item.price"
                    (input)="updatePrice(item, $event)"
                    min="0"
                    step="0.05"
                    [disabled]="item.orderType === 'MARKET'"
                    class="w-24 px-2 py-1 border border-gray-300 rounded-md  focus:ring-2 focus:ring-blue-100 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                    [placeholder]="item.orderType === 'MARKET' ? 'Market' : '0.00'"
                  />
                </td>

                <!-- Margin Required - Read Only -->
                <td class="px-4 py-3 ">
                  <span *ngIf="isCalculatingMargin" class="text-gray-400 text-sm animate-pulse">...</span>
                  <span *ngIf="!isCalculatingMargin" class="text-gray-700 font-medium ">₹{{ item.marginRequired | number: '1.2-2' }}</span>
                </td>

                <!-- Remove Button -->
                <td class="px-4 py-3 ">
                  <button
                    [matTooltip]="'Remove from Basket'"
                    (click)="removeFromBasket(i)"
                    class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors">
                    <fa-icon [icon]="faTrash" class="text-sm"></fa-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile Card View (Hidden on Desktop) -->
        <div *ngIf="basketItems.length > 0" class="md:hidden divide-y divide-gray-200">
          <div *ngFor="let item of basketItems; trackBy: trackById; let i = index"
               class="p-4 hover:bg-gray-50 transition-colors">

            <!-- Instrument Header -->
            <div class="mb-3">
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-700">{{ item.displayName }}</span>
                    <span class="text-sm text-gray-400 uppercase">{{ item.exchange }}</span>
                    <app-market-depth-invoker [title]="item.displayName"
                                            [instrumentToken]="item.instrumentToken"
                                            [iconColor]="'gray'">
                    </app-market-depth-invoker>
                    <span class="text-sm " [ngClass]="color(item.change)">
                      {{ item.lastPrice | number: '1.2-2' }}
                    </span>
                    <span class="text-sm px-1.5 py-0.5 rounded-md"
                          [ngClass]="{
                            'bg-green-50 text-green-600': item.change > 0,
                            'bg-red-50 text-red-600': item.change < 0,
                            'bg-gray-50 text-gray-600': item.change === 0
                          }">
                      {{ item.change / 100 | percent: '1.2-2' }}
                    </span>
                  </div>
                </div>
                <button
                  (click)="removeFromBasket(i)"
                  class="p-2 text-red-600 hover:bg-red-50 rounded-md transition-colors ml-2 flex-shrink-0"
                  [matTooltip]="'Remove from Basket'">
                  <fa-icon [icon]="faTrash" class="text-sm"></fa-icon>
                </button>
              </div>
            </div>

            <!-- Order Details Grid -->
            <div class="grid grid-cols-2 gap-3">
              <!-- Transaction Type -->
              <div>
                <label [for]="'transaction-' + i" class="text-sm text-gray-500 block mb-1">Transaction</label>
                <div class="cursor-pointer"
                     [id]="'transaction-' + i"
                     (click)="toggleTransactionType(item)"
                     (keydown.enter)="toggleTransactionType(item)"
                     tabindex="0"
                     role="button">

                  <app-small-chip class="mr-2" [text]="item.transactionType" [color]="item.transactionType === 'BUY' ? 'blue' : 'red'"></app-small-chip>
                  <app-small-chip [text]="item.productType" [color]="item.productType === 'MIS' ? 'orange':'purple'"></app-small-chip>

                </div>
              </div>

              <!-- Order Type -->
              <div>
                <label [for]="'orderType-' + i" class="text-sm text-gray-500 block mb-1">Order Type</label>
                <div class="cursor-pointer"
                     [id]="'orderType-' + i"
                     (click)="toggleOrderType(item)"
                     (keydown.enter)="toggleOrderType(item)"
                     tabindex="0"
                     role="button">
                  <app-small-chip [text]="item.orderType" [color]="'gray'"></app-small-chip>
                </div>
              </div>

              <!-- Quantity -->
              <div>
                <label [for]="'quantity-' + i" class="text-sm text-gray-500 block mb-1">Quantity</label>
                <input
                  [id]="'quantity-' + i"
                  type="number"
                  [(ngModel)]="item.quantity"
                  (input)="updateQuantity(item, $event)"
                  min="1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-100 focus:outline-none"
                />
              </div>

              <!-- Price -->
              <div>
                <label [for]="'price-' + i" class="text-sm text-gray-500 block mb-1">Price</label>
                <input
                  [id]="'price-' + i"
                  type="number"
                  [(ngModel)]="item.price"
                  (input)="updatePrice(item, $event)"
                  min="0"
                  step="0.05"
                  [disabled]="item.orderType === 'MARKET'"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-100 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                  [placeholder]="item.orderType === 'MARKET' ? 'Market' : '0.00'"
                />
              </div>
            </div>

            <!-- Margin Info -->
            <div class="mt-3 pt-3 border-t border-gray-100">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-500">Margin Required</span>
                <span class="text-sm font-medium text-gray-700">
                  <span *ngIf="isCalculatingMargin" class="text-gray-400 animate-pulse">...</span>
                  <span *ngIf="!isCalculatingMargin">₹{{ item.marginRequired | number: '1.2-2' }}</span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Footer -->
      <div *ngIf="basketItems.length > 0" class="border-t border-gray-200 bg-gradient-to-br from-gray-50 to-gray-100">
        <!-- Mobile Layout -->
        <div class="md:hidden p-4 space-y-3">
          <!-- Margin Overview Card -->
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-100">
              <span class="text-sm  text-gray-700  tracking-wide">Margin Overview for Total Items</span>
              <span class="text-sm text-gray-700">{{ basketItems.length }}</span>
            </div>

            <div class="space-y-2">
              <!-- Net Premium Section (prominent display) -->
                <div class="flex justify-between items-center">
                  <span class="text-sm" [ngClass]="{
                            'text-green-700': isNetCredit(),
                            'text-red-700': isNetDebit(),
                            'text-gray-700': netPremium === 0
                    }">Net Premium</span>
                  <div class="text-right">
                    <span class="text-sm font-medium" [ngClass]="{
                              'text-green-600': isNetCredit(),
                              'text-red-500': isNetDebit(),
                              'text-gray-600': netPremium === 0
                      }">
                      ₹{{ getAbsoluteNetPremium() | number: '1.2-2' }}
                    </span>

                  </div>
                </div>
              <div class="h-px bg-gray-200 my-2"></div>
              <!-- First line: Utilized + Available -->
              <div class="grid grid-cols-2 gap-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-700">Utilized</span>
                  <span class="text-sm font-medium text-gray-700">₹{{ utilizedMargin | number: '1.0-0' }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-700">Available</span>
                  <span class="text-sm font-medium text-gray-700">₹{{ availableMargin | number: '1.0-0' }}</span>
                </div>
              </div>

              <div class="h-px bg-gray-200 my-2"></div>
              <!-- Second line: Required + Final -->
              <div class="grid grid-cols-2 gap-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-700">Required</span>
                  <span class="text-sm font-medium text-gray-700">
                    <span *ngIf="!isCalculatingMargin">₹{{ requiredMargin | number: '1.0-0' }}</span>
                  </span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-700">Final</span>
                  <span
                    class="text-base font-medium"
                    [ngClass]="{
                        'text-green-600': finalMargin <= availableMargin,
                        'text-red-500': finalMargin > availableMargin
                      }"
                     >
                    <span *ngIf="!isCalculatingMargin">₹{{ finalMargin | number: '1.0-0' }}</span>
                  </span>
                </div>
              </div>
            </div>

          </div>

          <!-- Checkbox -->
          <div class="flex items-center gap-2 bg-white rounded-lg p-3 shadow-sm border border-gray-200">
            <input
              type="checkbox"
              id="includePositionsMobile"
              [(ngModel)]="includeExistingPositions"
              (change)="calculateBasketMargin()"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-100"
            />
            <label for="includePositionsMobile" class="text-sm text-gray-700 cursor-pointer select-none flex-1">
              Include Existing Positions
            </label>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col gap-2">
            <button (click)="placeBasketOrders();" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 active:from-blue-800 active:to-blue-900 transition-all font-medium shadow-md">
             Execute
            </button>
          </div>
        </div>

        <!-- Desktop Layout -->
        <div class="hidden md:block p-4">
          <!-- Top Row: Margin Stats -->
          <div class="grid grid-cols-6 gap-3 mb-4">
            <!-- Total Items -->
            <div class="bg-white rounded-md p-3 shadow-sm border border-gray-200 text-center">
              <div class="text-sm text-gray-700 mb-1 ">Items</div>
              <div class="text-lg font-medium text-gray-700">{{ basketItems.length }}</div>
            </div>

            <!-- Net Premium -->
            <div class="bg-gradient-to-br rounded-md p-3 shadow-sm border" [ngClass]="{
                          'border-green-200 from-green-100 to-emerald-50': isNetCredit(),
                          'border-red-200 from-red-100 to-red-50': isNetDebit(),
                          'border-gray-200 from-gray-100 to-gray-50': netPremium === 0
                  }">
                <div class="text-sm mb-1" [ngClass]="{
                            'text-green-600': isNetCredit(),
                            'text-red-500': isNetDebit(),
                            'text-gray-600': netPremium === 0
                    }">
                        Net Premium
                </div>
                <div class="text-lg font-bold" [ngClass]="{
                          'text-green-600': isNetCredit(),
                          'text-red-500': isNetDebit(),
                          'text-gray-600': netPremium === 0
                  }">
                  ₹{{ getAbsoluteNetPremium() | number: '1.2-2' }}
                  <span class="text-xs font-normal ml-1" *ngIf="netPremium !== 0">
                    {{ isNetDebit() ? '(Debit)' : '(Credit)' }}
                  </span>
                </div>
            </div>

            <!-- Utilized Margin -->
            <div class="bg-white rounded-md p-3 shadow-sm border border-gray-200">
              <div class="text-sm text-gray-700 mb-1 ">Utilized Margin</div>
              <div class="text-lg font-medium text-gray-700">₹{{ utilizedMargin | number: '1.0-0' }}</div>
            </div>
            <!-- Available Margin -->
            <div class="bg-white rounded-md p-3 shadow-sm border border-gray-200">
              <div class="text-sm text-gray-700 mb-1 ">Available Margin</div>
              <div class="text-lg font-medium text-gray-700">₹{{ availableMargin | number: '1.0-0' }}</div>
            </div>

            <!-- Required Margin -->
            <div class="bg-white rounded-md p-3 shadow-sm border border-gray-200">
              <div class="text-sm text-gray-700 mb-1 ">Required Margin</div>
              <div class="text-lg font-medium text-gray-700">
                <span *ngIf="!isCalculatingMargin">₹{{ requiredMargin | number: '1.0-0' }}</span>
              </div>
            </div>

            <!-- Final Margin -->
            <div class="bg-gradient-to-br  rounded-md p-3 shadow-sm border" [ngClass]="{
                          'border-green-200 from-green-100 to-emerald-50': finalMargin <= availableMargin,
                          'border-red-200 from-red-100 to-red-50': finalMargin > availableMargin
                  }">
                <div class="text-sm mb-1" [ngClass]="{
                            'text-green-600': finalMargin <= availableMargin,
                            'text-red-500': finalMargin > availableMargin
                    }">
                        Final Margin
                </div>
                <div class="text-lg font-bold" [ngClass]="{
                          'text-green-600': finalMargin <= availableMargin,
                          'text-red-500': finalMargin > availableMargin
                  }">
                  <span *ngIf="!isCalculatingMargin">₹{{ finalMargin | number: '1.0-0' }}</span>
                </div>
            </div>
          </div>

          <!-- Bottom Row: Actions -->
          <div class="flex items-center justify-between gap-4">
            <!-- Checkbox -->
            <div class="flex items-center gap-2 bg-white rounded-lg px-4 py-2.5 shadow-sm border border-gray-200">
              <input
                type="checkbox"
                id="includePositions"
                [(ngModel)]="includeExistingPositions"
                (change)="calculateBasketMargin()"
                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-100"
              />
              <label for="includePositions" class="text-sm text-gray-700 cursor-pointer select-none">
                Include Existing Positions
              </label>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
              <button
                (click)="calculateBasketMargin(); fetchFundsData()"
                [disabled]="isCalculatingMargin"
                class="px-6 py-2.5 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-sm">
                <span *ngIf="!isCalculatingMargin">Refresh Margins</span>
              </button>
              <button (click)="placeBasketOrders();" class="px-8 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 active:from-blue-800 active:to-blue-900 transition-all font-medium shadow-md">
              Execute
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
